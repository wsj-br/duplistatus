# Changelog

## Unreleased

### Added
- Added audit log entry when a new backup log is uploaded via the `/api/upload` endpoint. The audit log includes details about the backup (server ID, server name, backup name, status, date, duration, file counts, sizes, warnings, and errors) along with the client IP address and user agent for tracking purposes.
- Added duplicate server detection and merge feature in database maintenance settings. Administrators can now view servers with duplicate names and merge them into a single server. The merge operation transfers all backup records and configurations to the target server (newest by creation date) and deletes the old server entries. The feature includes a checkbox interface for selecting which duplicate servers to merge, with a confirmation dialog showing merge details before execution.
- Added GET `/api/servers/duplicates` endpoint to detect duplicate servers (servers with the same name but different IDs). Returns an array of duplicate groups with server details including ID, creation date, alias, note, and server URL.
- Added POST `/api/servers/merge` endpoint to merge duplicate servers. Accepts an array of old server IDs and a target server ID, updates all backup records, cleans up configuration entries (backup_settings and overdue_notifications), merges server metadata (password, alias, note, server_url), and deletes old server entries. All operations are performed within a database transaction for atomicity.
- Added database utility functions `getDuplicateServers()` and `mergeServers()` in `db-utils.ts` for duplicate detection and server merging operations.
- Added SQL queries `getDuplicateServers` and `updateBackupServerId` to `db.ts` for duplicate detection and backup server_id updates.
- Improved database maintenance form layout with a 2-column grid on larger screens. The Database Cleanup Period and Delete Backup Job sections are now displayed side-by-side on medium and larger screens, while stacking vertically on smaller screens. The Delete Server Data and Duplicate Servers sections remain full-width for better visibility.
- Added new API endpoint `/api/backups/sync-schedule` to synchronize schedule information from Duplicati servers. This endpoint connects to the server, retrieves schedule information for all backups, and updates the backup_settings configuration accordingly. Unlike the `/api/backups/collect` endpoint, this endpoint does not collect backup logs or save JSON files, making it faster and more focused on schedule synchronization. The endpoint supports the same authentication methods as the collect endpoint (serverId, hostname/port/password, or serverId with updates). When schedule information includes a schedule time, the `time` field in backup_settings is updated with the schedule time from Duplicati.
- Added key icon (KeyRound) click handler in server settings form. Clicking the key icon next to a server name now opens the password change dialog, providing a quick way to update server passwords directly from the server list.
- Updated backup collection endpoint (`/api/backups/collect`) to extract and update schedule time information. When collecting backups, the endpoint now extracts the schedule time from each backup's schedule information and updates the `time` field in backup_settings if a schedule time is available. This ensures that the expected next backup run time is synchronized with the actual schedule configured in Duplicati.
- Added configuration incomplete notice in email settings form. When email configuration is incomplete, a yellow alert box is displayed informing users that no emails will be sent until the email settings are filled correctly. The notice includes a reminder to always test email settings before relying on them for notifications.
- Added "(disabled)" labels to Email and NTFY notification checkboxes in backup notifications settings when their respective services are not configured. This makes it clearer to users when notification channels are disabled due to incomplete configuration.
- Added `set-smtp-test-config.ts` script to set SMTP test configuration from environment variables. The script accepts a connectionType parameter (plain, starttls, ssl) and reads corresponding environment variables with prefixes (PLAIN_, STARTTLS_, SSL_) to update the SMTP configuration in the database. For plain connections, the script reads `PLAIN_SMTP_FROM` environment variable to set the required From Address. This facilitates testing different SMTP connection types without manual database updates.
- Added `test-smtp-connections.ts` script to test SMTP connection type cross-compatibility. This script performs a comprehensive 3x3 matrix test that validates whether configurations meant for one connection type work correctly with different connection types. For each base configuration type (plain, starttls, ssl), the script reads environment variables with corresponding prefixes (PLAIN_*, STARTTLS_*, SSL_*), then tests all three connection types by modifying only the `connectionType` field. The script sends test emails via the API, records results in a matrix format, displays a summary table, and saves detailed results to `smtp-test-results.json`. Usage: `pnpm test-smtp-connections`. The script requires the application to be running and validates the configuration being used through detailed logging. Expected behavior: configurations should only work with their intended connection type (e.g., plain config works with plain connectionType but fails with starttls/ssl).
- Added support for plain SMTP connections (no encryption) on port 25. The email configuration form now includes a button group to select between three connection types: "Plain SMTP", "STARTTLS", and "Direct SSL/TLS". Plain SMTP connections are useful for trusted local networks but are not recommended for production use over untrusted networks.
- Added configurable sender name and from address fields in email configuration. Users can now customize the display name and email address shown as the sender in email notifications. If not configured, defaults to "duplistatus" as sender name and SMTP username as from address for backward compatibility.
- Added SMTP authentication requirement toggle in email configuration form. Users can now configure SMTP servers that don't require authentication. When authentication is disabled, the username and password fields are automatically disabled.
- Added email format validation for recipient email and from address fields. Both fields now require the '@' symbol to be considered valid.
- Enhanced test email content to display:
  - SMTP server hostname and port
  - Connection type (Plain SMTP, STARTTLS, or Direct SSL/TLS)
  - SMTP authentication requirement status
  - SMTP username (only shown when authentication is required)
  - Recipient email address
  - From address and sender name used for the email
  - Test timestamp

### Changed
- Updated toolbar components (Duplicati configuration button and collect button) to automatically refresh server lists when database maintenance operations are performed. The server lists now update immediately after deleting server data, deleting backup jobs, or merging duplicate servers, ensuring users always see the current server configuration when using these toolbar buttons.
- Updated server settings form to automatically refresh toolbar components when server configuration changes. The Duplicati configuration and collect buttons in the toolbar now refresh their server lists immediately after saving server details (URL, alias, note), changing a server password, or deleting a server password.
- Updated email icon color validation logic in settings page left panel to match the form validation logic. The icon now correctly shows green (valid) when all required fields are set: SMTP Server Host, SMTP Server Port, Recipient Email, and either (SMTP Username + Password when authentication is required) or (From Address when authentication is not required).
- Changed default email connection type from STARTTLS to Direct SSL/TLS. New email configurations will default to Direct SSL/TLS (recommended for port 465) instead of STARTTLS. Existing configurations are unaffected.
- Simplified SMTP configuration storage by removing the legacy `secure` flag. The UI/API now rely solely on `connectionType` (Plain SMTP, STARTTLS, Direct SSL/TLS), and transporter creation derives the correct Nodemailer options from that single value.
- Changed From Address field to be required for Plain SMTP connections. When Plain SMTP connection type is selected, the From Address field becomes mandatory to ensure proper email sender identification and RFC 5322 compliance. The From Address is also required when SMTP authentication is disabled for other connection types.

### Fixed
- Fixed missing 'From' header in email messages that caused RFC 5322 compliance errors (e.g., Gmail rejecting emails). The `sendEmailNotification()` function now ensures the From address is always set by using a fallback chain: configured From Address â†’ SMTP Username (with validation). For Plain SMTP connections, From Address is strictly required and the function throws a specific error if it's missing. The recipient email (mailto) is no longer used as a fallback to ensure proper email sender identification.
- Fixed `log_ts` function in `docker-entrypoint.sh` that was silently dropping most log messages. The function now logs all messages instead of only those containing "ðŸ””", "WAL checkpoint completed successfully", or "âœ…". This restores visibility into critical operational messages including startup notifications, shutdown status messages, exit codes, and error conditions.
- Fixed email encryption for STARTTLS connections (port 587). The implementation now properly requires TLS encryption for STARTTLS connections by setting `requireTLS: true` when `secure: false`. This ensures that connections to SMTP servers on port 587 are always encrypted, even when authentication is not required. Port 465 connections with direct SSL/TLS (`secure: true`) were already properly encrypted.
- Fixed SMTP transporter configuration to correctly honor Plain SMTP, STARTTLS, and Direct SSL/TLS selections. Connection handling now sets `secure`, `requireTLS`, and `ignoreTLS` consistently and provides clearer error messages that include the original transport error for easier troubleshooting.
- Fixed Plain SMTP connections failing with TLS negotiation errors. The `createEmailTransporter()` function was incorrectly applying TLS configuration to all connection types, causing Plain SMTP connections to attempt TLS negotiation even when `ignoreTLS: true` was set. Now TLS configuration is only applied to STARTTLS and SSL connection types, and Plain SMTP connections work correctly without any TLS configuration.
- Fixed unsaved email configuration fields being cleared when clicking "Change Password" button. The form now automatically saves the current configuration before opening the password dialog, preserving any unsaved changes. Additionally, the form state is protected from being overwritten during password operations to prevent data loss.
- Fixed stale SMTP configuration being used in test email API endpoint. The `/api/notifications/test` endpoint now clears the request cache before reading SMTP configuration, ensuring that external scripts (like `test-smtp-connections.ts`) can update the configuration and have it immediately reflected in test emails. This prevents the API from using cached configuration values when the database has been updated.
- Fixed password visibility toggle behavior in server settings. Both password input fields (new password and confirm password) now toggle visibility together when either eye icon is clicked, providing a more consistent user experience when changing server passwords.

### Security
- Upgraded to Next.js 16.0.7 and React 19.2.1 to fix CVE-2025-55182 (React Server Components vulnerability) and CVE-2025-66478 (Next.js vulnerability).

