#!/bin/bash

# Function to extract DNS configuration from host
get_dns_config() {
    local dns_args=""
    local search_args=""
    
    # Try to use resolvectl for systemd-resolved systems (best method)
    if command -v resolvectl >/dev/null 2>&1; then
        # Get all DNS servers from all interfaces (deduplicate)
        local seen_dns=""
        while IFS= read -r line; do
            if [[ "$line" =~ DNS\ Servers:\ (.+) ]]; then
                for ns in ${BASH_REMATCH[1]}; do
                    # Skip IPv6 addresses (contain :) and duplicates
                    if [[ "$ns" != *":"* && ! "$seen_dns" =~ "$ns" ]]; then
                        dns_args="$dns_args --dns $ns"
                        seen_dns="$seen_dns $ns"
                    fi
                done
            elif [[ "$line" =~ Current\ DNS\ Server:\ (.+) ]]; then
                local ns="${BASH_REMATCH[1]}"
                # Skip IPv6 addresses and duplicates
                if [[ "$ns" != *":"* && ! "$seen_dns" =~ "$ns" ]]; then
                    dns_args="$dns_args --dns $ns"
                    seen_dns="$seen_dns $ns"
                fi
            fi
        done < <(resolvectl status 2>/dev/null)
        
        # Get search domains from all interfaces (deduplicate)
        local seen_search=""
        while IFS= read -r line; do
            if [[ "$line" =~ DNS\ Domain:\ (.+) ]]; then
                for domain in ${BASH_REMATCH[1]}; do
                    # Skip reverse DNS domains (start with ~) and duplicates
                    if [[ "$domain" != ~* && ! "$seen_search" =~ "$domain" ]]; then
                        search_args="$search_args --dns-search $domain"
                        seen_search="$seen_search $domain"
                    fi
                done
            fi
        done < <(resolvectl status 2>/dev/null)
    else
        # Fallback: parse resolv.conf
        local resolv_file="/etc/resolv.conf"
        
        # If systemd-resolved stub, try to get real config
        if grep -q "^nameserver 127.0.0.53" "$resolv_file" 2>/dev/null; then
            if [ -f "/run/systemd/resolve/resolv.conf" ]; then
                resolv_file="/run/systemd/resolve/resolv.conf"
            fi
        fi
        
        # Extract nameservers (skip localhost and IPv6)
        while IFS= read -r line; do
            if [[ "$line" =~ ^nameserver[[:space:]]+([^[:space:]]+) ]]; then
                local ns="${BASH_REMATCH[1]}"
                if [[ "$ns" != "127.0.0.53" && "$ns" != "::1" && "$ns" != *":"* ]]; then
                    dns_args="$dns_args --dns $ns"
                fi
            fi
        done < "$resolv_file"
        
        # Extract search domains
        while IFS= read -r line; do
            if [[ "$line" =~ ^search[[:space:]]+(.+) ]]; then
                for domain in ${BASH_REMATCH[1]}; do
                    search_args="$search_args --dns-search $domain"
                done
                break
            fi
        done < "$resolv_file"
    fi
    
    echo "$dns_args $search_args"
}

# test the container inside a POD (podman)

echo "--------------------------------------------------------------"
echo "starting the pod test"


echo "--------------------------------------------------------------"
echo "copying the image from docker to podman"
./copy.docker.duplistatus.local 
podman image ls
echo "--------------------------------------------------------------"
echo "stoping the pod and removing the container"
podman pod stop Duplistatus && podman pod rm Duplistatus
echo "--------------------------------------------------------------"
echo "creating the pod with DNS from host"
DNS_CONFIG=$(get_dns_config)
echo "Using DNS configuration:$DNS_CONFIG"
podman pod create --name Duplistatus --publish 9666:9666/tcp $DNS_CONFIG
echo "--------------------------------------------------------------"
echo "creating the container"
podman create --name duplistatus --pod Duplistatus --user root --sysctl net.ipv6.conf.all.disable_ipv6=1 \
        -v ./data:/app/data docker.io/wsj-br/duplistatus:devel
echo "--------------------------------------------------------------"
echo "starting the pod"
podman pod start Duplistatus
echo "sleeping for 10 seconds"
sleep 10
echo "--------------------------------------------------------------"
echo "checking the container"
./check.duplistatus 
echo "--------------------------------------------------------------"
echo "listing the debug log"
ls -la data/debug.log 
echo "--------------------------------------------------------------"
echo "showing the debug log"
cat data/debug.log 
echo "--------------------------------------------------------------"
echo "done"
echo "--------------------------------------------------------------"

exit 0