"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[2096],{6533:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>t,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"development/workspace-admin-scripts-commands","title":"Workspace Admin Scripts & Commands","description":"Clean Database","source":"@site/docs/development/workspace-admin-scripts-commands.md","sourceDirName":"development","slug":"/development/workspace-admin-scripts-commands","permalink":"/duplistatus/development/workspace-admin-scripts-commands","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"mainSidebar","previous":{"title":"Test Scripts","permalink":"/duplistatus/development/test-scripts"},"next":{"title":"Cron Service","permalink":"/duplistatus/development/cron-service"}}');var a=n(2238),c=n(9371);const r={},t="Workspace Admin Scripts & Commands",l={},d=[{value:"Clean Database",id:"clean-database",level:2},{value:"Clean build artefacts and dependencies",id:"clean-build-artefacts-and-dependencies",level:2},{value:"Clean Docker Compose and Docker environment",id:"clean-docker-compose-and-docker-environment",level:2},{value:"Update the packages to the latest version",id:"update-the-packages-to-the-latest-version",level:2},{value:"Check for unused packages",id:"check-for-unused-packages",level:2},{value:"Update version information",id:"update-version-information",level:2},{value:"Pre-checks script",id:"pre-checks-script",level:2},{value:"Ensure key file exists",id:"ensure-key-file-exists",level:2},{value:"Admin account recovery",id:"admin-account-recovery",level:2},{value:"Docker build script",id:"docker-build-script",level:2},{value:"Docker Compose with version",id:"docker-compose-with-version",level:2},{value:"Copy images",id:"copy-images",level:2},{value:"Viewing the configurations in the database",id:"viewing-the-configurations-in-the-database",level:2},{value:"SQL Scripts for Debugging and Maintenance",id:"sql-scripts-for-debugging-and-maintenance",level:2},{value:"Delete Backup Settings",id:"delete-backup-settings",level:3},{value:"Delete Last Backup",id:"delete-last-backup",level:3}];function o(e){const s={code:"code",div:"div",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",span:"span",strong:"strong",ul:"ul",...(0,c.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(s.header,{children:(0,a.jsx)(s.h1,{id:"workspace-admin-scripts--commands",children:"Workspace Admin Scripts & Commands"})}),"\n",(0,a.jsx)(s.h2,{id:"clean-database",children:"Clean Database"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"./scripts/clean-db.sh\n"})}),"\n",(0,a.jsx)(s.p,{children:"Cleans the database by removing all data while preserving the database schema and structure."}),"\n",(0,a.jsxs)(s.div,{className:"markdown-alert markdown-alert-caution",children:["\n",(0,a.jsxs)(s.p,{className:"markdown-alert-title",children:[(0,a.jsx)(s.span,{className:"octicon octicon-caution",style:{"--oct-icon":"url(\"data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-stop mr-2' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true'%3E%3Cpath d='M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z'%3E%3C/path%3E%3C/svg%3E\")"}}),"Caution"]}),"\n",(0,a.jsx)(s.p,{children:"Use with caution as this will delete all existing data."}),"\n"]}),"\n",(0,a.jsx)(s.h2,{id:"clean-build-artefacts-and-dependencies",children:"Clean build artefacts and dependencies"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"scripts/clean-workspace.sh\n"})}),"\n",(0,a.jsx)(s.p,{children:"Removes all build artefacts, node_modules directory, and other generated files to ensure a clean state. This is useful when you need to perform a fresh installation or resolve dependency issues. The command will delete:"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsxs)(s.li,{children:[(0,a.jsx)(s.code,{children:"node_modules/"})," directory"]}),"\n",(0,a.jsxs)(s.li,{children:[(0,a.jsx)(s.code,{children:".next/"})," build directory"]}),"\n",(0,a.jsxs)(s.li,{children:[(0,a.jsx)(s.code,{children:"dist/"})," directory"]}),"\n",(0,a.jsx)(s.li,{children:"All Docker build cache and perform a Docker system prune"}),"\n",(0,a.jsx)(s.li,{children:"pnpm store cache"}),"\n",(0,a.jsx)(s.li,{children:"Unused Docker system resources (images, networks, volumes)"}),"\n",(0,a.jsx)(s.li,{children:"Any other build cache files"}),"\n"]}),"\n",(0,a.jsx)(s.h2,{id:"clean-docker-compose-and-docker-environment",children:"Clean Docker Compose and Docker environment"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"scripts/clean-docker.sh\n"})}),"\n",(0,a.jsx)(s.p,{children:"Perform a complete Docker cleanup, which is useful for:"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"Freeing up disk space"}),"\n",(0,a.jsx)(s.li,{children:"Removing old/unused Docker artefacts"}),"\n",(0,a.jsx)(s.li,{children:"Cleaning up after development or testing sessions"}),"\n",(0,a.jsx)(s.li,{children:"Maintaining a clean Docker environment"}),"\n"]}),"\n",(0,a.jsx)(s.h2,{id:"update-the-packages-to-the-latest-version",children:"Update the packages to the latest version"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"ncu --upgrade\npnpm update\n"})}),"\n",(0,a.jsx)(s.h2,{id:"check-for-unused-packages",children:"Check for unused packages"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"pnpm depcheck\n"})}),"\n",(0,a.jsx)(s.h2,{id:"update-version-information",children:"Update version information"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"./scripts/update-version.sh\n"})}),"\n",(0,a.jsxs)(s.p,{children:["This script automatically updates the ",(0,a.jsx)(s.code,{children:".env"})," file with the current version from ",(0,a.jsx)(s.code,{children:"package.json"}),". It:"]}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsxs)(s.li,{children:["Extracts the version from ",(0,a.jsx)(s.code,{children:"package.json"})]}),"\n",(0,a.jsxs)(s.li,{children:["Creates or updates the ",(0,a.jsx)(s.code,{children:".env"})," file with the ",(0,a.jsx)(s.code,{children:"VERSION"})," variable"]}),"\n",(0,a.jsx)(s.li,{children:"Only updates if the version has changed"}),"\n",(0,a.jsx)(s.li,{children:"Provides feedback on the operation"}),"\n"]}),"\n",(0,a.jsx)(s.h2,{id:"pre-checks-script",children:"Pre-checks script"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"./scripts/pre-checks.sh\n"})}),"\n",(0,a.jsx)(s.p,{children:"This script runs pre-checks before starting the development server, building, or starting the production server. It:"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsxs)(s.li,{children:["Ensures the ",(0,a.jsx)(s.code,{children:".duplistatus.key"})," file exists (via ",(0,a.jsx)(s.code,{children:"ensure-key-file.sh"}),")"]}),"\n",(0,a.jsxs)(s.li,{children:["Updates the version information (via ",(0,a.jsx)(s.code,{children:"update-version.sh"}),")"]}),"\n"]}),"\n",(0,a.jsxs)(s.p,{children:["This script is automatically called by ",(0,a.jsx)(s.code,{children:"pnpm dev"}),", ",(0,a.jsx)(s.code,{children:"pnpm build"}),", and ",(0,a.jsx)(s.code,{children:"pnpm start-local"}),"."]}),"\n",(0,a.jsx)(s.h2,{id:"ensure-key-file-exists",children:"Ensure key file exists"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"./scripts/ensure-key-file.sh\n"})}),"\n",(0,a.jsxs)(s.p,{children:["This script ensures the ",(0,a.jsx)(s.code,{children:".duplistatus.key"})," file exists in the ",(0,a.jsx)(s.code,{children:"data"})," directory. It:"]}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsxs)(s.li,{children:["Creates the ",(0,a.jsx)(s.code,{children:"data"})," directory if it doesn't exist"]}),"\n",(0,a.jsx)(s.li,{children:"Generates a new 32-byte random key file if missing"}),"\n",(0,a.jsx)(s.li,{children:"Sets file permissions to 0400 (read-only for owner)"}),"\n",(0,a.jsx)(s.li,{children:"Fixes permissions if they are incorrect"}),"\n"]}),"\n",(0,a.jsx)(s.p,{children:"The key file is used for cryptographic operations in the application."}),"\n",(0,a.jsx)(s.h2,{id:"admin-account-recovery",children:"Admin account recovery"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"tsx scripts/admin-recovery.ts <username> <new-password>\n"})}),"\n",(0,a.jsx)(s.p,{children:"This script allows recovery of admin accounts if locked out or password forgotten. It:"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"Resets the password for the specified user"}),"\n",(0,a.jsx)(s.li,{children:"Unlocks the account if it was locked"}),"\n",(0,a.jsx)(s.li,{children:"Resets failed login attempts counter"}),"\n",(0,a.jsx)(s.li,{children:'Clears the "must change password" flag'}),"\n",(0,a.jsx)(s.li,{children:"Validates password meets security requirements"}),"\n",(0,a.jsx)(s.li,{children:"Logs the action to the audit log"}),"\n"]}),"\n",(0,a.jsx)(s.p,{children:(0,a.jsx)(s.strong,{children:"Example:"})}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"tsx scripts/admin-recovery.ts admin NewPassword123\n"})}),"\n",(0,a.jsxs)(s.div,{className:"markdown-alert markdown-alert-caution",children:["\n",(0,a.jsxs)(s.p,{className:"markdown-alert-title",children:[(0,a.jsx)(s.span,{className:"octicon octicon-caution",style:{"--oct-icon":"url(\"data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-stop mr-2' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true'%3E%3Cpath d='M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z'%3E%3C/path%3E%3C/svg%3E\")"}}),"Caution"]}),"\n",(0,a.jsx)(s.p,{children:"This script directly modifies the database. Use only when necessary for account recovery."}),"\n"]}),"\n",(0,a.jsx)(s.h2,{id:"docker-build-script",children:"Docker build script"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"./scripts/docker-build.sh\n"})}),"\n",(0,a.jsxs)(s.p,{children:["Builds a Docker image with the version from ",(0,a.jsx)(s.code,{children:".env"})," or ",(0,a.jsx)(s.code,{children:"package.json"}),". The script:"]}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsxs)(s.li,{children:["Extracts the version from ",(0,a.jsx)(s.code,{children:".env"})," file (or falls back to ",(0,a.jsx)(s.code,{children:"package.json"}),")"]}),"\n",(0,a.jsx)(s.li,{children:"Builds the Docker image with the version as a build argument"}),"\n",(0,a.jsxs)(s.li,{children:["Tags the image as ",(0,a.jsx)(s.code,{children:"duplistatus:$VERSION"})]}),"\n"]}),"\n",(0,a.jsx)(s.h2,{id:"docker-compose-with-version",children:"Docker Compose with version"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"./scripts/docker-compose-with-version.sh [docker-compose-args]\n"})}),"\n",(0,a.jsxs)(s.p,{children:["Runs docker-compose with the version automatically set from ",(0,a.jsx)(s.code,{children:".env"})," or ",(0,a.jsx)(s.code,{children:"package.json"}),". This script:"]}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"Exports the version as an environment variable"}),"\n",(0,a.jsx)(s.li,{children:"Passes all arguments to docker-compose"}),"\n",(0,a.jsx)(s.li,{children:"Ensures version consistency across Docker operations"}),"\n"]}),"\n",(0,a.jsx)(s.h2,{id:"copy-images",children:"Copy images"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"./scripts/copy-images.sh\n"})}),"\n",(0,a.jsxs)(s.p,{children:["Copies image files from ",(0,a.jsx)(s.code,{children:"website/static/img"})," to their appropriate locations in the application:"]}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsxs)(s.li,{children:["Copies ",(0,a.jsx)(s.code,{children:"favicon.ico"})," to ",(0,a.jsx)(s.code,{children:"src/app/"})]}),"\n",(0,a.jsxs)(s.li,{children:["Copies ",(0,a.jsx)(s.code,{children:"duplistatus_logo.png"})," to ",(0,a.jsx)(s.code,{children:"public/images/"})]}),"\n",(0,a.jsxs)(s.li,{children:["Copies ",(0,a.jsx)(s.code,{children:"duplistatus_banner.png"})," to ",(0,a.jsx)(s.code,{children:"public/images/"})]}),"\n"]}),"\n",(0,a.jsx)(s.p,{children:"Useful for keeping application images synchronized with documentation images."}),"\n",(0,a.jsx)(s.h2,{id:"viewing-the-configurations-in-the-database",children:"Viewing the configurations in the database"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:'sqlite3 data/backups.db "SELECT key, value FROM configurations;" | awk -F\'|\' \'\n  {print "\\n" $1 ": "; \n   if(index($2,"{")>0) {print $2 |"jq -C ."; close("jq -C .")} \n   else {print $2;}}\' | less -R\n'})}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:'sqlite3 /var/lib/docker/volumes/duplistatus_data/_data/backups.db "SELECT key, value FROM configurations;" | awk -F\'|\' \'\n  {print "\\n" $1 ": "; \n   if(index($2,"{")>0) {print $2 |"jq -C ."; close("jq -C .")} \n   else {print $2;}}\' | less -R\n'})}),"\n",(0,a.jsx)(s.h2,{id:"sql-scripts-for-debugging-and-maintenance",children:"SQL Scripts for Debugging and Maintenance"}),"\n",(0,a.jsx)(s.p,{children:"The project includes SQL scripts for database maintenance:"}),"\n",(0,a.jsx)(s.h3,{id:"delete-backup-settings",children:"Delete Backup Settings"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"sqlite3 data/backups.db < scripts/delete-backup-settings.sql\n"})}),"\n",(0,a.jsx)(s.p,{children:"This script removes all backup settings from the configurations table. Use with caution as this will reset all backup notification configurations."}),"\n",(0,a.jsx)(s.h3,{id:"delete-last-backup",children:"Delete Last Backup"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"sqlite3 data/backups.db < scripts/delete-last-backup.sql\n"})}),"\n",(0,a.jsx)(s.p,{children:"This script removes the most recent backup record for each server. By default, it deletes the last backup for ALL servers. The script includes commented examples for targeting specific servers by name. Useful for testing and debugging purposes."}),"\n",(0,a.jsxs)(s.p,{children:[(0,a.jsx)(s.strong,{children:"Note"}),": The script has been updated to work with the current database schema (uses ",(0,a.jsx)(s.code,{children:"servers"})," table and ",(0,a.jsx)(s.code,{children:"server_id"})," column)."]}),"\n",(0,a.jsxs)(s.div,{className:"markdown-alert markdown-alert-caution",children:["\n",(0,a.jsxs)(s.p,{className:"markdown-alert-title",children:[(0,a.jsx)(s.span,{className:"octicon octicon-caution",style:{"--oct-icon":"url(\"data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-stop mr-2' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true'%3E%3Cpath d='M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z'%3E%3C/path%3E%3C/svg%3E\")"}}),"Caution"]}),"\n",(0,a.jsx)(s.p,{children:"These SQL scripts directly modify the database. Always backup your database before running these scripts."}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,c.R)(),...e.components};return s?(0,a.jsx)(s,{...e,children:(0,a.jsx)(o,{...e})}):o(e)}},9371:(e,s,n)=>{n.d(s,{R:()=>r,x:()=>t});var i=n(3790);const a={},c=i.createContext(a);function r(e){const s=i.useContext(c);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function t(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),i.createElement(c.Provider,{value:s},e.children)}}}]);