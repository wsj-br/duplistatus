# Vers√£o 1.2.1 {#version-121}

## Vis√£o geral {#overview}

Vers√£o 1.2.1 √© uma vers√£o menor que introduz melhorias significativas no gerenciamento de notifica√ß√µes de backup, melhora os recursos de log de auditoria, corrige a detec√ß√£o de pr√≥xima execu√ß√£o/atraso em casos extremos e adiciona funcionalidade de backup e restaura√ß√£o do banco de dados. Esta vers√£o se concentra em melhorar a experi√™ncia do usu√°rio com as configura√ß√µes de notifica√ß√£o.

## Novos recursos {#new-features}

### Gerenciamento aprimorado de notifica√ß√µes de backup {#enhanced-backup-notifications-management}

- **Padr√µes em n√≠vel de servidor e sistema de heran√ßa**: Configure destinos adicionais padr√£o (eventos de notifica√ß√£o, e-mails e t√≥picos NTFY) no n√≠vel do servidor que todos os backups herdam automaticamente. Os backups podem substituir esses padr√µes quando necess√°rio, com indicadores visuais claros mostrando o status de heran√ßa.
- **Hierarquia visual melhorada**: Os backups agora s√£o agrupados por servidor com linhas de cabe√ßalho de servidor distintas. Os valores herdados s√£o claramente marcados com √≠cones de link, e os valores substitu√≠dos podem ser facilmente revertidos para heran√ßa.
- **Opera√ß√µes em massa**: O bot√£o "Sincronizar com todos" limpa todas as substitui√ß√µes de backup para fazer com que todos os backups herdem dos padr√µes do servidor. O bot√£o "Limpar tudo" limpa todos os destinos adicionais mantendo a estrutura de heran√ßa.
- **Funcionalidade de teste**: Adicionados bot√µes de teste de e-mail e teste de notifica√ß√£o diretamente na p√°gina de configura√ß√µes de Notifica√ß√µes de backup. Os bot√µes de teste est√£o dispon√≠veis para configura√ß√µes de backup individual e opera√ß√µes de edi√ß√£o em massa, permitindo que voc√™ verifique a entrega de notifica√ß√µes antes de aplicar altera√ß√µes.
- **Suporte a c√≥digo QR**: Adicionado bot√£o de c√≥digo QR para t√≥picos NTFY para compartilhar facilmente t√≥picos de notifica√ß√£o com dispositivos m√≥veis.

### Melhorias de modelo de notifica√ß√£o {#notification-template-enhancements}

- **Nova vari√°vel `{log_text}`**: Adicionada vari√°vel `{log_text}` aos modelos de notifica√ß√£o, fornecendo acesso a mensagens de texto de log para uso em mensagens de notifica√ß√£o. A vari√°vel cont√©m o texto completo de avisos e erros combinados, formatado como texto simples com um item por linha.
- **Migra√ß√£o autom√°tica de modelo**: O sistema inclui um mecanismo de atualiza√ß√£o lenta que detecta e atualiza automaticamente modelos padr√£o antigos quando s√£o lidos pela primeira vez ap√≥s uma atualiza√ß√£o. Os modelos personalizados s√£o preservados inalterados.

### Gerenciamento de banco de dados {#database-management}

- **Funcionalidade de backup do banco de dados**: Os administradores agora podem criar backups de todo o banco de dados na p√°gina de configura√ß√µes de Manuten√ß√£o do banco de dados. Suporta formatos bin√°rio (.db) e texto SQL (.sql) para flexibilidade.
- **Funcionalidade de restaura√ß√£o do banco de dados**: Restaure o banco de dados a partir de arquivos de backup criados anteriormente com cria√ß√£o autom√°tica de backup de seguran√ßa, valida√ß√£o de integridade e revers√£o em caso de falha. Todas as sess√µes s√£o limpas ap√≥s a restaura√ß√£o por seguran√ßa.

### Detec√ß√£o de chave mestra {#master-key-detection}

- **Detec√ß√£o autom√°tica de altera√ß√£o de chave mestra**: Ap√≥s o login, o sistema verifica automaticamente se o arquivo `.duplistatus.key` foi alterado. Se detectado, todas as senhas criptografadas s√£o limpas e um popup modal informa aos usu√°rios que as senhas precisam ser reconfiguradas. Isso evita erros ao restaurar a partir de backups ou migrar para um novo sistema.

### Melhorias no monitoramento de backups atrasados {#overdue-monitoring-improvements}

- **Exporta√ß√£o CSV aprimorada**: Adicionada coluna "Data e hora do √∫ltimo backup (BD)" ao arquivo CSV gerado pelo bot√£o "Baixar CSV" nas configura√ß√µes de monitoramento de backups atrasados. Isso permite que os usu√°rios comparem a data e hora real do √∫ltimo backup do banco de dados com a data e hora do "√öltimo backup" configurada.
- **Dica de ferramenta de pr√≥xima execu√ß√£o**: Passar o mouse sobre o valor "Pr√≥xima execu√ß√£o" em cada linha agora exibe uma dica de ferramenta mostrando a data e hora do √∫ltimo backup do banco de dados, formatada da mesma forma que a exibi√ß√£o "Pr√≥xima execu√ß√£o".

### Melhorias no log de auditoria {#audit-logging-enhancements}

- **Entradas de auditoria de notifica√ß√£o individual**: Cada notifica√ß√£o e e-mail enviado agora gera uma entrada de log de auditoria separada com detalhes sobre o canal, configura√ß√£o e resultado (sucesso ou falha). Isso inclui notifica√ß√µes de teste, fornecendo melhor rastreabilidade para entrega de notifica√ß√µes.
- **Registro de falha robusto**: Todas as opera√ß√µes de log de auditoria para falhas de notifica√ß√£o agora s√£o envolvidas em blocos try-catch para evitar que erros de log de auditoria quebrem fluxos de notifica√ß√£o. O sistema tenta recuperar a configura√ß√£o SMTP se n√£o estiver imediatamente dispon√≠vel ao registrar falhas de e-mail.
- **Log de auditoria melhorado para atualiza√ß√µes de configura√ß√£o**: As entradas de log de auditoria `email_config_updated` e `ntfy_config_updated` agora registram apenas quando h√° altera√ß√µes reais na configura√ß√£o. Quando altera√ß√µes s√£o detectadas, o log de auditoria inclui valores antigos e novos para cada campo modificado, facilitando o rastreamento do que foi alterado especificamente.

### Melhorias na documenta√ß√£o {#documentation-improvements}

- O estilo da documenta√ß√£o foi atualizado para se alinhar com a apar√™ncia e sensa√ß√£o do aplicativo. A barra lateral tamb√©m foi revisada para melhorar a visibilidade e facilitar a navega√ß√£o.

---

## üêõ Corre√ß√µes de bugs {#bug-fixes}

- **Timestamps de log de auditoria corrigidos**: Os timestamps no visualizador de log de auditoria agora exibem corretamente no fuso hor√°rio do navegador do usu√°rio em vez de GMT. Os timestamps SQLite (armazenados em UTC) agora s√£o analisados corretamente como UTC e convertidos para o fuso hor√°rio local do navegador para exibi√ß√£o.
- **C√°lculo de "Pr√≥xima execu√ß√£o" corrigido e detec√ß√£o de atraso**: A coluna "Pr√≥xima execu√ß√£o" nas configura√ß√µes de monitoramento de backups atrasados agora calcula e exibe com precis√£o a pr√≥xima data de backup esperada, levando em conta tanto o agendamento de backup quanto a data e hora do √∫ltimo backup. Isso se aplica a trabalhos de backup agendados e executados manualmente, resultando em detec√ß√£o de atraso mais confi√°vel.

---

## üöÄ Notas de migra√ß√£o {#migration-notes}

### Da vers√£o 1.1.x {#from-version-11x}

Ao atualizar para a vers√£o 1.2.1:

1. **Modelos de notifica√ß√£o**: O sistema atualizar√° automaticamente os modelos de notifica√ß√£o padr√£o para incluir a nova vari√°vel `{log_text}` na primeira vez que forem acessados ap√≥s a atualiza√ß√£o. Os modelos personalizados permanecer√£o inalterados. Se voc√™ deseja usar a nova vari√°vel `{log_text}` em seus pr√≥prios modelos, ser√° necess√°rio atualiz√°-los ou restaurar os modelos padr√£o manualmente.

2. **Altera√ß√µes de chave mestra**: Se voc√™ restaurar a partir de um backup ou migrar para um novo sistema com um arquivo `.duplistatus.key` diferente, o sistema detectar√° automaticamente isso e solicitar√° que voc√™ reconfigure as senhas criptografadas (senhas SMTP e senhas do servidor Duplicati).

3. **Backup/Restaura√ß√£o do banco de dados**: A nova funcionalidade de backup e restaura√ß√£o do banco de dados est√° dispon√≠vel na p√°gina de configura√ß√µes de Manuten√ß√£o do banco de dados. √â recomend√°vel criar um backup antes de atualizar, embora nenhuma altera√ß√£o de esquema de banco de dados seja necess√°ria para esta vers√£o.

4. **Nenhuma migra√ß√£o de banco de dados necess√°ria**: Esta vers√£o n√£o requer nenhuma altera√ß√£o de esquema de banco de dados.

---

## Endpoints de API {#api-endpoints}

Os seguintes endpoints de API foram introduzidos nesta vers√£o.

### Endpoints de autentica√ß√£o e seguran√ßa {#authentication-security-endpoints}

- `GET /api/auth/admin-must-change-password` - Verificar se o usu√°rio administrador deve alterar a senha

### Endpoints de gerenciamento de banco de dados {#database-management-endpoints}

- `GET /api/database/backup` - Criar backup do banco de dados (formato bin√°rio ou SQL)
- `POST /api/database/restore` - Restaurar banco de dados a partir do arquivo de backup

### Endpoints de gerenciamento de backup {#backup-management-endpoints}

- `GET /api/backups/last-timestamps` - Obter datas e horas do √∫ltimo backup para todas as combina√ß√µes de servidor-backup

---

## Suporte {#support}

### Obtendo ajuda {#getting-help}

- **Documenta√ß√£o**: [Guia do usu√°rio](../user-guide/overview.md)
- **Configura√ß√µes de e-mail**: [Guia de configura√ß√£o de e-mail](../user-guide/settings/email-settings.md)
- **Refer√™ncia de API**: [Documenta√ß√£o de API](../api-reference/overview.md)
- **Guia de migra√ß√£o**: [Migra√ß√£o de atualiza√ß√£o de vers√£o](../migration/version_upgrade.md)
- **Comunidade**: [Discuss√µes do GitHub](https://github.com/wsj-br/duplistatus/discussions)
- **Problemas**: [Problemas do GitHub](https://github.com/wsj-br/duplistatus/issues)

### Relatando bugs {#reporting-bugs}

Ao relatar bugs, inclua:

- Vers√£o: 1.2.1
- Sistema operacional e vers√£o
- Vers√£o do Docker/podman
- Tipo de cont√™iner (Docker ou podman/Pod)
- Mensagens de erro e logs
- Etapas para reproduzir

---

## Changelog {#changelog}

### Altera√ß√µes da vers√£o 1.2.1 {#version-121-changes}

- **Adicionado**: Sistema de padr√µes em n√≠vel de servidor e heran√ßa para notifica√ß√µes de backup
- **Adicionado**: Funcionalidade de teste de e-mail e teste de notifica√ß√£o nas configura√ß√µes de Notifica√ß√µes de backup
- **Adicionado**: Bot√£o de c√≥digo QR para t√≥picos NTFY
- **Adicionado**: Coluna "Data e hora do √∫ltimo backup (BD)" para exporta√ß√£o CSV de monitoramento de backups atrasados
- **Adicionado**: Dica de ferramenta para texto "Pr√≥xima execu√ß√£o" nas configura√ß√µes de monitoramento de backups atrasados
- **Adicionado**: Entradas de log de auditoria individual para cada notifica√ß√£o e e-mail enviado
- **Adicionado**: Robustez aprimorada de log de auditoria para falhas de notifica√ß√£o
- **Adicionado**: Vari√°vel `{log_text}` para modelos de notifica√ß√£o com migra√ß√£o autom√°tica de modelo
- **Adicionado**: Detec√ß√£o autom√°tica de altera√ß√µes de arquivo de chave mestra
- **Adicionado**: Funcionalidade de backup do banco de dados (formatos bin√°rio e SQL)
- **Adicionado**: Funcionalidade de restaura√ß√£o do banco de dados com backups de seguran√ßa e valida√ß√£o de integridade
- **Adicionado**: Endpoint de API `GET /api/auth/admin-must-change-password` para verificar o requisito de altera√ß√£o de senha do administrador
- **Adicionado**: Endpoint de API `GET /api/database/backup` para criar backups do banco de dados
- **Adicionado**: Endpoint de API `POST /api/database/restore` para restaurar banco de dados a partir de backup
- **Adicionado**: Endpoint de API `GET /api/backups/last-timestamps` para recuperar datas e horas do √∫ltimo backup
- **Alterado**: Log de auditoria melhorado para atualiza√ß√µes de configura√ß√£o de e-mail e NTFY (registra apenas altera√ß√µes reais)
- **Alterado**: Formul√°rios de altera√ß√£o de senha n√£o exigem mais confirma√ß√£o ao mostrar senhas desmascaradas.
- **Alterado**: As senhas s√£o limpas com seguran√ßa da mem√≥ria quando os formul√°rios de altera√ß√£o de senha s√£o fechados.
- **Alterado**: Inclu√≠do um alternador de visualiza√ß√£o de senha no formul√°rio de coleta de backups.
- **Alterado**: A vari√°vel `{server_alias}` agora mostra o nome do servidor entre colchetes
- **Alterado**: Documenta√ß√£o atualizada, estilo alinhado com o aplicativo e barra lateral refatorada.
- **Corrigido**: Timestamps de log de auditoria exibindo em GMT em vez de fuso hor√°rio do navegador
- **Corrigido**: Log de auditoria de falha de e-mail e NTFY
- **Corrigido**: Exibi√ß√£o de "Pr√≥xima execu√ß√£o" nas configura√ß√µes de monitoramento de backups atrasados mostrando datas incorretas

---

## Licen√ßa {#license}

Este projeto √© licenciado sob a [Licen√ßa Apache 2.0](https://github.com/wsj-br/duplistatus/blob/main/LICENSE).

**Copyright ¬© 2025 Waldemar Scudeller Jr.**
