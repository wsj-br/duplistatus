# Vers√£o 0.9.x {#version-09x}

## vis√£o geral {#overview}

Vers√£o 0.9.x √© uma vers√£o principal que introduz um **Sistema abrangente de Controle de Acesso de Usu√°rio e Seguran√ßa**. Esta vers√£o transforma **duplistatus** de um aplicativo de acesso aberto em um Sistema seguro e multi-usu√°rio com controle de acesso baseado em fun√ß√µes, Log de Auditoria abrangente e recursos de Seguran√ßa de n√≠vel empresarial. Toda a funcionalidade existente agora est√° protegida por autentica√ß√£o, garantindo que apenas Usu√°rios autorizados possam acessar e gerenciar o backup de monitoramento.

## Mudan√ßas Significativas {#breaking-changes}

### Autentica√ß√£o Necess√°ria {#authentication-required}

- **Todas as P√°ginas agora requerem autentica√ß√£o** - Usu√°rios devem Entrar para acessar o aplicativo
- **Conta de admin Padr√£o** √© criada automaticamente:
  - Nome de usu√°rio: `admin`
  - Senha: `Duplistatus09` (deve ser alterada no primeiro Login)
- **Sess√µes existentes s√£o invalidadas** - Todos os Usu√°rios devem Entrar ap√≥s a atualiza√ß√£o
- **Os endpoints da API Agora requerem autentica√ß√£o** - Integra√ß√µes externas devem incluir cookies de sess√£o ou usar solicita√ß√µes autenticadas

:::warning
**Todos os Usu√°rios devem Entrar ap√≥s atualizar para a Vers√£o 0.9.x.** As credenciais de admin Padr√£o s√£o admin/Duplistatus09. Altere a Senha imediatamente ap√≥s o primeiro Login.
:::

### Migra√ß√£o de Esquema de Banco de Dados {#database-schema-migration}

- **Migra√ß√£o autom√°tica de v3.1 para v4.0** para instala√ß√µes existentes
- **Novas tabelas adicionadas**: `users`, `sessions`, `audit_log`
- **Backup do banco de dados criado automaticamente** antes da migra√ß√£o
- **Novas instala√ß√µes** Iniciam diretamente com esquema v4.0 (nenhuma migra√ß√£o necess√°ria)

## Novos Recursos {#new-features}

### Sistema de Controle de Acesso de Usu√°rio e Seguran√ßa {#user-access-control-security-system}

#### Sistema de Autentica√ß√£o {#authentication-system}

- **Funcionalidade de Login/Sair de Usu√°rio** com gerenciamento seguro de sess√£o
- **Autentica√ß√£o baseada em Senha** com hash bcrypt (fator de custo 12)
- **Mecanismo de bloqueio de conta** (5 tentativas com Falha, bloqueio de 15 minutos)
- **Altera√ß√£o de Senha for√ßada** no primeiro Login
- **Aplica√ß√£o de pol√≠tica de Senha**:
  - M√≠nimo de 8 caracteres
  - Pelo menos uma letra mai√∫scula
  - Pelo menos uma letra min√∫scula
  - Pelo menos um n√∫mero
  - Caracteres especiais opcionais
- **Funcionalidade "Lembrar de mim"** com persist√™ncia de Nome de usu√°rio em localStorage
- **Autentica√ß√£o baseada em sess√£o** com sess√µes apoiadas por banco de dados (substitui na mem√≥ria)
- **Prote√ß√£o CSRF** integrada com autentica√ß√£o
- **Cookies somente HTTP** para Seguran√ßa de sess√£o
- **Rastreamento de Endere√ßo IP e Agente do usu√°rio** para monitoramento de Seguran√ßa

#### Gerenciamento de usu√°rios (Apenas Admin) {#user-management-admin-only}

- **Cria√ß√£o de Usu√°rio** com gera√ß√£o autom√°tica de Senha tempor√°ria
- **Lista de Usu√°rio** com Pesquisar, pagina√ß√£o e Filtrar
- **Edi√ß√£o de Usu√°rio** (Nome de usu√°rio, Status de admin, requisito de altera√ß√£o de Senha)
- **Funcionalidade de Redefini√ß√£o de Senha** com exibi√ß√£o de Senha tempor√°ria
- **Exclus√£o de Usu√°rio** com salvaguardas (impede exclus√£o de √öltima de admin)
- **Controle de acesso baseado em Fun√ß√£o** (Fun√ß√µes Admin/Usu√°rio)
- **Indicadores de Status** (Ativo, Bloqueado, Deve alterar a Senha)
- **Rastreamento de √öltimo login** e exibi√ß√£o

#### Sistema de Log de Auditoria {#audit-logging-system}

- **Trilha de auditoria abrangente** para Todos os A√ß√µes de Sistema e Usu√°rio
- **Visualizador de log de auditoria** com Filtrar avan√ßado:
  - Filtragem de intervalo de Data
  - Filtragem de Usu√°rio
  - Filtragem de A√ß√£o
  - Filtragem de Categoria
  - Filtragem de Status
- **Funcionalidade de Exportar** (formatos CSV e JSON)
- **Estat√≠sticas de Log de Auditoria** e an√°lise
- **Per√≠odo de reten√ß√£o configur√°vel** (30-365 dias, padr√£o: 90 dias)
- **Trabalho cron de limpeza autom√°tica** (executado diariamente √†s 2 AM UTC)
- **API de limpeza manual** com suporte de execu√ß√£o seca
- **Log de Auditoria para**:
  - Eventos de autentica√ß√£o (Login, Sair, altera√ß√µes de Senha, bloqueios de conta)
  - Opera√ß√µes de Gerenciamento de usu√°rios (criar, atualizar, Excluir, Redefini√ß√µes de Senha)
  - Altera√ß√µes de configura√ß√£o (E-mail, NTFY, Modelos, toler√¢ncia atrasado, configura√ß√µes de backup)
  - Opera√ß√µes de backup (coleta, exclus√£o, limpeza)
  - Gerenciamento de servidores (Adicionar, atualizar, Excluir)
  - Opera√ß√µes de Sistema (migra√ß√µes, limpeza, Notifica√ß√µes)

### Redesenho da P√°gina de Configura√ß√µes {#settings-page-redesign}

- **Navega√ß√£o moderna da barra lateral** com barra lateral recolh√≠vel
- **Persist√™ncia de estado da barra lateral espec√≠fica do Usu√°rio** (prefer√™ncia recolhida/expandida Salva por Usu√°rio)
- **Se√ß√µes de configura√ß√µes agrupadas**:
  - **Notifica√ß√µes**: Notifica√ß√µes de backup, Monitoramento de backups atrasados, Modelos
  - **Integra√ß√µes**: NTFY, E-mail
  - **Sistema**: Servidores, Usu√°rios (apenas admin), Log de Auditoria
- **Barra lateral fixa** que permanece vis√≠vel durante a rolagem
- **Design responsivo** com espa√ßamento otimizado
- **√çcone de Configura√ß√µes e t√≠tulo "Configura√ß√µes de Sistema"** no cabe√ßalho da barra lateral
- **Bot√£o Voltar** integrado ao cabe√ßalho do aplicativo

### Melhorias na Interface do Usu√°rio {#user-interface-enhancements}

- **P√°gina de Login aut√¥noma** com design moderno
- **Caixa de sele√ß√£o "Lembrar de mim"** no formul√°rio de Login para persist√™ncia de Nome de usu√°rio
- **Bot√µes Mostrar/Ocultar Senha** nos formul√°rios de Login e altera√ß√£o de Senha
- **Modal Alterar Senha** com lista de verifica√ß√£o de valida√ß√£o em tempo real
- **Indicador de Usu√°rio e bot√£o Sair** no cabe√ßalho do aplicativo
- **Visibilidade da interface do usu√°rio baseada em Fun√ß√£o** (recursos apenas para admin Ocultar de Usu√°rios regulares)
- **Crach√°s e indicadores de Status** em toda a interface do usu√°rio
- **Prefer√™ncias espec√≠ficas do Usu√°rio** armazenadas em localStorage (por exemplo, estado da barra lateral recolhida)

### Recursos de Seguran√ßa {#security-features}

- **Hash de Senha** com bcrypt (padr√£o da ind√∫stria)
- **Sanitiza√ß√£o de dados sens√≠veis** em Logs de Auditoria (Senhas, tokens, segredos Nunca registrados)
- **Limita√ß√£o de taxa** para tentativas de Login
- **Expira√ß√£o de sess√£o** (24 horas)
- **Valida√ß√£o de token CSRF** para Todos os opera√ß√µes que alteram estado
- **Ferramenta CLI de recupera√ß√£o de admin** para Redefini√ß√£o de Senha se bloqueado

### Ferramentas para Desenvolvedores {#developer-tools}

- **Script CLI de recupera√ß√£o de admin** (`admin-recovery`) para f√°cil execu√ß√£o em cont√™ineres Docker
- **Funciona tanto localmente quanto em Docker** com detec√ß√£o autom√°tica de caminho
- **Interfaces TypeScript abrangentes** (N√£o tipos `any`)
- **Middleware de autentica√ß√£o** para prote√ß√£o de rota
- **Classe utilit√°ria de logger de auditoria** com m√©todos de conveni√™ncia

---

## üöÄ Notas de Migra√ß√£o {#migration-notes}

### Da Vers√£o 0.8.x {#from-version-08x}

Esta vers√£o introduz autentica√ß√£o e requer que Todos os Usu√°rios Entrem. Ao atualizar da Vers√£o 0.8.x:

1. **Migra√ß√£o Autom√°tica de Banco de Dados**: O aplicativo migrar√° automaticamente seu esquema de banco de dados de v3.1 para v4.0
2. **Backup do banco de dados**: Um backup autom√°tico √© criado antes da migra√ß√£o
3. **Conta de Admin Padr√£o**: Uma conta de admin Padr√£o √© criada:
   - Nome de usu√°rio: `admin`
   - Senha: `Duplistatus09`
   - **Voc√™ deve alterar esta Senha no primeiro Login**
4. **Invalida√ß√£o de Sess√£o**: Todas as sess√µes existentes s√£o invalidadas
5. **Login de Usu√°rio Necess√°rio**: Todos os Usu√°rios devem Entrar ap√≥s a atualiza√ß√£o
6. **Autentica√ß√£o de API**: Integra√ß√µes externas devem ser atualizadas para incluir autentica√ß√£o

### Considera√ß√µes de Seguran√ßa {#security-considerations}

- **Altere a Senha Padr√£o**: Altere a Senha de admin Padr√£o imediatamente ap√≥s o primeiro Login
- **Criar Contas de Usu√°rio**: Crie contas de Usu√°rio individuais para cada pessoa que precisa de acesso
- **Revisar Logs de Auditoria**: Verifique Logs de Auditoria regularmente para monitoramento de Seguran√ßa
- **Configurar Reten√ß√£o**: Defina o per√≠odo de reten√ß√£o de Log de Auditoria apropriado com base em seus requisitos de conformidade
- **Backup da Chave Mestra**: Se estiver atualizando de 0.8.x, certifique-se de que o arquivo `.duplistatus.key` est√° em backup

### Etapas do Primeiro Login {#first-login-steps}

1. **Entrar** com credenciais Padr√£o (`admin` / `Duplistatus09`)
2. **Alterar Senha** quando solicitado (for√ßado no primeiro Login)
3. **Criar contas de Usu√°rio** para outros Usu√°rios (Configura√ß√µes ‚Üí Usu√°rios)
4. **Configurar reten√ß√£o de log de auditoria** se necess√°rio (Configura√ß√µes ‚Üí Log de Auditoria)
5. **Revisar Logs de Auditoria** para verificar se o Sistema est√° funcionando corretamente

---

## üêõ Corre√ß√µes de Bugs {#bug-fixes}

- Problemas de persist√™ncia de sess√£o corrigidos em reinicializa√ß√µes de Servidores
- Tratamento de Erro melhorado para falhas de autentica√ß√£o
- Feedback de valida√ß√£o de Senha aprimorado
- Inconsist√™ncias de interface do usu√°rio corrigidas na P√°gina de Configura√ß√µes
- Desempenho de Filtrar de Log de Auditoria melhorado

---

## Endpoints da API {#api-endpoints}

### Endpoints de Autentica√ß√£o {#authentication-endpoints}

- `POST /api/auth/login` - Autentica√ß√£o de Usu√°rio
- `POST /api/auth/logout` - Encerramento de sess√£o
- `GET /api/auth/me` - Informa√ß√µes de Usu√°rio Atual
- `POST /api/auth/change-password` - Altera√ß√£o de Senha

### Endpoints de Gerenciamento de usu√°rios (Apenas Admin) {#user-management-endpoints-admin-only}

- `GET /api/users` - Listar Usu√°rios
- `POST /api/users` - Criar Usu√°rio
- `PATCH /api/users/{id}` - Atualizar Usu√°rio
- `DELETE /api/users/{id}` - Excluir Usu√°rio

### Endpoints de Log de Auditoria {#audit-log-endpoints}

- `GET /api/audit-log` - Consultar Logs de Auditoria
- `GET /api/audit-log/download` - Exportar Logs de Auditoria
- `GET /api/audit-log/stats` - Estat√≠sticas de auditoria
- `POST /api/audit-log/cleanup` - Limpeza manual (apenas admin)
- `GET /api/audit-log/retention` - Obter configura√ß√£o de reten√ß√£o
- `PATCH /api/audit-log/retention` - Atualizar reten√ß√£o (apenas admin)

:::note
Todos os endpoints da API Agora requerem autentica√ß√£o. Consulte a [Refer√™ncia da API](../api-reference/authentication-security.md) para Detalhes sobre autentica√ß√£o.
:::

---

## Suporte {#support}

### Obtendo Ajuda {#getting-help}

- **Documenta√ß√£o**: [Guia do Usu√°rio](../user-guide/overview.md)
- **Refer√™ncia da API**: [Documenta√ß√£o da API](../api-reference/authentication-security.md)
- **Guia de Migra√ß√£o**: [Migra√ß√£o de Atualiza√ß√£o de Vers√£o](../migration/version_upgrade.md)
- **Recupera√ß√£o de Admin**: [Recupera√ß√£o de Conta de Admin](../user-guide/admin-recovery.md)
- **Comunidade**: [Discuss√µes do GitHub](https://github.com/wsj-br/duplistatus/discussions)
- **Problemas**: [Problemas do GitHub](https://github.com/wsj-br/duplistatus/issues)

### Relatando Bugs {#reporting-bugs}

Ao relatar bugs, inclua:

- Vers√£o: 0.9.x
- Sistema operacional e Vers√£o
- Vers√£o do Docker
- Mensagens de Erro e Logs
- Etapas para reproduzir
- Fun√ß√£o de Usu√°rio (admin/Usu√°rio) se relevante

---

## Registro de Altera√ß√µes {#changelog}

### Altera√ß√µes Detalhadas {#detailed-changes}

- **Adicionado**: Sistema completo de autentica√ß√£o e autoriza√ß√£o
- **Adicionado**: Gerenciamento de usu√°rios com controle de acesso baseado em Fun√ß√£o
- **Adicionado**: Sistema abrangente de Log de Auditoria
- **Adicionado**: Redesenho da P√°gina de Configura√ß√µes com barra lateral recolh√≠vel
- **Adicionado**: Ferramenta CLI de recupera√ß√£o de admin
- **Adicionado**: Aplica√ß√£o de pol√≠tica de Senha
- **Adicionado**: Mecanismo de bloqueio de conta
- **Adicionado**: Gerenciamento de sess√£o com persist√™ncia de banco de dados
- **Alterado**: Todas as P√°ginas Agora requerem autentica√ß√£o
- **Alterado**: Esquema de banco de dados de v3.1 para v4.0
- **Alterado**: Armazenamento de sess√£o de na mem√≥ria para apoiado por banco de dados
- **Alterado**: Layout e navega√ß√£o da P√°gina de Configura√ß√µes
- **Corrigido**: Persist√™ncia de sess√£o em reinicializa√ß√µes de Servidores
- **Corrigido**: V√°rias inconsist√™ncias de interface do usu√°rio
- **Melhorado**: Postura de Seguran√ßa com Log de Auditoria abrangente
- **Melhorado**: Experi√™ncia do Usu√°rio com p√°ginas de Login e Configura√ß√µes modernas
- **Melhorado**: Qualidade de c√≥digo com interfaces TypeScript e princ√≠pios DRY

---

## Licen√ßa {#license}

Este projeto √© licenciado sob a [Licen√ßa Apache 2.0](https://github.com/wsj-br/duplistatus/blob/main/LICENSE).

**Copyright ¬© 2025 Waldemar Scudeller Jr.**

